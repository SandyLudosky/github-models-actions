name: Python Tests & GitHub Models Docs

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch: {}

permissions:
  contents: write   # needed to commit generated markdown
  models: read      # needed to call GitHub Models

jobs:
  tests:
    name: Run Python Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -r requirements.txt || true

      - name: Run tests
        run: pytest -q

  generate-docs:
    name: Generate GitHub Models Markdown
    runs-on: ubuntu-latest
    needs: tests   # ðŸ‘ˆ only generate docs if tests pass

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call GitHub Models (generate markdown)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p docs

          RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d '{
              "model": "openai/gpt-4o",
              "messages": [
                {
                  "role": "system",
                  "content": "You are a technical writer. Output Markdown only."
                },
                {
                  "role": "user",
                  "content": "Write a README-style Markdown document explaining GitHub Models: what it is, how to use it with GitHub Actions, required permissions, an example curl request, and best practices."
                }
              ]
            }')

          echo "$RESPONSE" > docs/github-models.response.json
          jq -r '.choices[0].message.content' docs/github-models.response.json > docs/github-models.md

      - name: Update README.md
        run: |
          if [ -f README.md ]; then
            if ! grep -q "docs/github-models.md" README.md; then
              printf "\n## GitHub Models\n\nSee: [docs/github-models.md](docs/github-models.md)\n" >> README.md
            fi
          else
            cat > README.md << 'EOF'
          # Project

          ## GitHub Models

          See: [docs/github-models.md](docs/github-models.md)
          EOF
          fi

      - name: Commit generated documentation
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add docs/github-models.md docs/github-models.response.json README.md || true
          git commit -m "docs: generate GitHub Models documentation (Markdown)" || exit 0
          git push
